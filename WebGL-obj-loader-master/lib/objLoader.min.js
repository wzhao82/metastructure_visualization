var StringParser=function(b){this.str=null;this.index=0;this.init(b)};StringParser.prototype.init=function(b){this.str=b;this.index=0};StringParser.prototype.skipDelimiters=function(){for(var b=this.index,a=this.str.length;b<a;b++){var c=this.str.charAt(b);if("\t"!=c&&" "!=c&&"("!=c&&")"!=c&&'"'!=c)break}this.index=b};StringParser.prototype.skipToNextWord=function(){this.skipDelimiters();var b=getWordLength(this.str,this.index);this.index+=b+1};
StringParser.prototype.getWord=function(){this.skipDelimiters();var b=getWordLength(this.str,this.index);if(0==b)return null;var a=this.str.substr(this.index,b);this.index+=b+1;return a};StringParser.prototype.getInt=function(){return parseInt(this.getWord())};StringParser.prototype.getFloat=function(){return parseFloat(this.getWord())};function getWordLength(b,a){for(var c=a,d=b.length;c<d;c++){var g=b.charAt(c);if("\t"==g||" "==g||"("==g||")"==g||'"'==g)break}return c-a}
var MTLDoc=function(){this.complete=!1;this.materials=[]};MTLDoc.prototype.parseNewmtl=function(b){return b.getWord()};MTLDoc.prototype.parseRGB=function(b,a){var c=b.getFloat(),d=b.getFloat(),g=b.getFloat();return new Material(a,c,d,g,1)};
var Material=function(b,a,c,d,g){this.name=b;this.color=new Color(a,c,d,g)},Vertex=function(b,a,c){this.x=b;this.y=a;this.z=c},VTertex=function(b,a){this.x=b;this.y=a},Normal=function(b,a,c){this.x=b;this.y=a;this.z=c},Color=function(b,a,c,d){this.r=b;this.g=a;this.b=c;this.a=d},OBJObject=function(b){this.name=b;this.faces=[];this.numIndices=0};OBJObject.prototype.addFace=function(b){this.faces.push(b);this.numIndices+=b.numIndices};
var Face=function(b){this.materialName=b;null==b&&(this.materialName="");this.vIndices=[];this.nIndices=[];this.tIndices=[]},DrawingInfo=function(b,a,c,d,g){this.vertices=b;this.normals=a;this.colors=c;this.indices=d;this.textureVt=g},OBJDoc=function(b){this.fileName=b;this.mtls=[];this.objects=[];this.vertices=[];this.normals=[];this.textureVt=[]};function parseMtllib(b,a){var c=a.lastIndexOf("/"),d="";0<c&&(d=a.substr(0,c+1));return d+b.getWord()}
function parseObjectName(b){b=b.getWord();return new OBJObject(b)}function parseVertex(b,a){var c=b.getFloat()*a,d=b.getFloat()*a,g=b.getFloat()*a;return new Vertex(c,d,g)}function parseVTertex(b,a){var c=b.getFloat()*a,d=b.getFloat()*a;return new VTertex(c,d)}function parseNormal(b){var a=b.getFloat(),c=b.getFloat();b=b.getFloat();return new Normal(a,c,b)}function parseUsemtl(b){return b.getWord()}var iiii=1;
function parseFace(b,a,c,d,g,k){for(a=new Face(a);;){var h=b.getWord();if(!h||!h.replace(/^\s+|\s+$/g,""))break;var e;e=h.split("/");if(1<=e.length){var l=0>parseInt(e[0])?c.length+parseInt(e[0]):parseInt(e[0])-1;4>iiii&&console.log(l,"vi",parseInt(e[0]),e,h,h.replace(/^\s+|\s+$/g,""));a.vIndices.push(l)}2<=e.length&&e[1]&&(h=0>parseInt(e[1])?d.length+parseInt(e[1]):parseInt(e[1])-1,a.tIndices.push(h));3<=e.length?(e=0>parseInt(e[2])?g.length+parseInt(e[2]):parseInt(e[2])-1,a.nIndices.push(e)):a.nIndices.push(-1)}4>
iiii&&console.log(a.vIndices,"face.vIndices",c[a.vIndices[0]],c[a.vIndices[1]],c[a.vIndices[2]]);e=[c[a.vIndices[0]].x,c[a.vIndices[0]].y,c[a.vIndices[0]].z];b=[c[a.vIndices[1]].x,c[a.vIndices[1]].y,c[a.vIndices[1]].z];g=[c[a.vIndices[2]].x,c[a.vIndices[2]].y,c[a.vIndices[2]].z];var m,n,f;if(3<=a.tIndices.length){if(!d[a.tIndices[0]])throw console.log("textureVt.length:",d.length,"face.tIndices[0]",a.tIndices,"face.tIndices.length",a.tIndices.length),"hhhh";m=[d[a.tIndices[0]].x,d[a.tIndices[0]].y];
n=[d[a.tIndices[1]].x,d[a.tIndices[1]].y];f=[d[a.tIndices[2]].x,d[a.tIndices[2]].y]}d=calcNormal(e,b,g);null==d&&(4<=a.vIndices.length&&(d=calcNormal(b,g,[c[a.vIndices[3]].x,c[a.vIndices[3]].y,c[a.vIndices[3]].z])),null==d&&(d=[0,1,0]));k&&(d[0]=-d[0],d[1]=-d[1],d[2]=-d[2]);a.normal=new Normal(d[0],d[1],d[2]);a.textureVt=[m,n,f];if(3<a.vIndices.length){c=a.vIndices.length-2;k=Array(3*c);m=Array(3*c);n=Array(3*c);for(f=0;f<c;f++)k[3*f]=a.vIndices[0],k[3*f+1]=a.vIndices[f+1],k[3*f+2]=a.vIndices[f+2],
m[3*f]=a.nIndices[0],m[3*f+1]=a.nIndices[f+1],m[3*f+2]=a.nIndices[f+2],n[3*f]=a.tIndices[0],n[3*f+1]=a.tIndices[f+1],n[3*f+2]=a.tIndices[f+2];a.vIndices=k;a.nIndices=m;a.tIndices=n;4>iiii&&console.log("face.vIndices",a.vIndices)}a.numIndices=a.vIndices.length;iiii++;return a}
function onReadMTLFile(b,a,c,d,g){b=b.split("\n");b.push(null);for(var k=0,h,e="",l=new StringParser;null!=(h=b[k++]);)if(l.init(h),h=l.getWord(),null!=h)switch(h){case "#":continue;case "newmtl":e=a.parseNewmtl(l);continue;case "Kd":""!=e&&(e=a.parseRGB(l,e),a.materials.push(e),e="")}a.complete=!0;a=0;b=!1;for(console.log("modelObject[index]",c[d].mtls);a<c[d].mtls.length;a++)c[d].mtls[a]&&(b=!0);g[d]=b;console.log(b,g)}
function OBJDocparser(b,a,c,d,g,k,h){b=b.split("\n");b.push(null);for(var e=0,l=null,m="",n=!1,f,p=new StringParser;null!=(f=b[e++]);)if(p.init(f),f=p.getWord(),null!=f)switch(f){case "#":continue;case "mtllib":n=!0;f=parseMtllib(p,this.fileName);var r=new MTLDoc;this.mtls.push(r);console.log(this.mtls,":this.mtls",a[h].mtls);var q=new XMLHttpRequest;q.onreadystatechange=function(){4==q.readyState&&(404!=q.status?onReadMTLFile(q.responseText,r,a,h,c):(c[h]=!a[h].mtls.some(function(a){return!a}),console.log("need a mtlib, but there is none",
c[h]),r.complete=!0))};q.onerror=function(a){console.log(a)};q.ontimeout=function(a){console.log("timeout",a)};q.open("GET",f,!0);q.send();continue;case "o":case "g":l=parseObjectName(p);this.objects.push(l);continue;case "v":f=parseVertex(p,g);this.vertices.push(f);continue;case "vn":f=parseNormal(p);this.normals.push(f);continue;case "usemtl":m=parseUsemtl(p);continue;case "f":f=parseFace(p,m,this.vertices,this.textureVt,this.normals,k);l.addFace(f);continue;case "vt":f=parseVTertex(p,1),this.textureVt.push(f)}d[h]=
!0;n||(c[h]=!0);return!0}function calcNormal(b,a,c){for(var d=new Float32Array(3),g=new Float32Array(3),k=0;3>k;k++)d[k]=b[k]-a[k],g[k]=c[k]-a[k];b=new Float32Array(3);b[0]=d[1]*g[2]-d[2]*g[1];b[1]=d[2]*g[0]-d[0]*g[2];b[2]=d[0]*g[1]-d[1]*g[0];d=new Vector3(b);d.normalize();return d.elements}
function findColor(b,a){for(var c=0;c<b.mtls.length;c++)for(var d=0;d<b.mtls[c].materials.length;d++)if(b.mtls[c].materials[d].name.replace(/^\s+|\s+$/g,"")==a.replace(/^\s+|\s+$/g,""))return b.mtls[c].materials[d].color;return new Color(1,1,1,1)}
function readOBJFile(b,a,c,d,g,k,h){var e=new XMLHttpRequest;e.onreadystatechange=function(){4===e.readyState&&404!==e.status&&(c[h]=!1,d[h]=!1,a[h]=new OBJDoc(b),OBJDocparser.bind(a[h])(e.responseText,a,c,d,g,k,h)||(g_drawingInfo=g_objDoc=null,console.log("OBJ file parsing error:",b)))};e.open("GET",b,!0);e.send()};
